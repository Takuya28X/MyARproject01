<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc , getDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";


  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyDDOHUnbja3li-KvU0hVRoIRAcScHadUyw",
    authDomain: "webar-visitapp.firebaseapp.com",
    projectId: "webar-visitapp",
    storageBucket: "webar-visitapp.firebasestorage.app",
    messagingSenderId: "991762844576",
    appId: "1:991762844576:web:c5eb7311cb0e069e5df2c5",
    measurementId: "G-QR1REFDLNT"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
signInAnonymously(auth)
  .then(() => {
    console.log("匿名ログイン成功");
  })
  .catch((error) => {
    console.error("匿名ログイン失敗:", error);
  });

onAuthStateChanged(auth , async(user) => {
  if (user){
    const uid = user.uid;
    const userRef = doc(db,"users",uid);
    try{
      const userSnap = await getDoc(userRef);
      if(userSnap.exists()){
      console.log("ログインしたことがあります");
      const username = userSnap.data().username;
      document.getElementById("username-form").style.display = "none";
      document.getElementById("greeting").innerText = `player ${username}`;
      document.getElementById("greeting").style.display = "block";
      //document.getElementById("namesetting-overlay").style.display = "none";
      document.getElementById("top").style.display = "none";
    }else{
      console.log("ログインしたことがありません");
      document.getElementById("username-form").style.display = "block";
    }
  } catch(e){
    console.error("データ取得エラー：",e);
  }
}});  

async function submitUsername() {
  const input = document.getElementById("username-input");
  const username = input.value.trim();
  if (!username) return alert("ユーザー名を入力してください");

  const uid = auth.currentUser.uid;
  const userRef = doc(db, "users", uid);
  await setDoc(userRef, { username: username }, { merge: true });

  document.getElementById("username-form").style.display = "none";
  document.getElementById("greeting").innerText = `player ${username}`;
  document.getElementById("greeting").style.display = "block";
  //document.getElementById("namesetting-overlay").style.display = "none";
  document.getElementById("top").style.display = "none";
}

window.submitUsername = submitUsername;

  </script>

  <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/ar.js/2.1.8/aframe/build/aframe-ar.min.js"></script>
</head>
<body style="margin: 0; overflow: hidden;">
  <style>
  #namesetting-overlay{
    display: block;
    background-color: rgb(118, 1, 1);
    width: 100%;
    height: 100%;
    z-index: 100;
  }

  #top{
    display: block;
    width: 100%;
    height: 100%;
    z-index: 100;
  }

  #username-form {
    position: absolute;
    top: 60%;
    left: 40%;
    z-index: 1000;
    background-color: rgba(255, 255, 255, 0.8); /* 半透明の白背景 */
    padding: 15px;
    border-radius: 10px;
  }

  #username-input {
    font-size: 16px;
    padding: 8px;
    width: 180px;
  }

  #submit-button {
    font-size: 14px;
    padding: 8px;
    margin-top: 8px;
  }

  #greeting {
    display: none;
    position: absolute;
    top: 20px;
    left: 30px;
    font-size: 20px;
    background-color: rgba(0, 128, 255, 0.8);
    color: white;
    padding: 10px;
    border-radius: 10px;
    z-index: 1000;
  }
 </style>

<!-- <div id = "namesetting-overlay"></div> -->
<img id = top src="C:\Users\taku3\Downloads\ChatGPT Image 2025年5月21日 00_09_38.png" alt="">
<div id = "username-form">
  <input type="text" id = "username-input" placeholder="ユーザー名を入力" />
  <button id = submit-button onclick = "submitUsername()" >送信</button>
</div>
<div id = "greeting" ></div>

  <a-scene id = "ar-scene" embedded arjs="debugUIEnabled: false;"> 
    <a-marker preset="hiro">
       <!-- <a-box position="0 0.5 0" color="red"></a-box> -->
    </a-marker>
    <a-entity camera></a-entity>
  </a-scene>

</body>
</html>
